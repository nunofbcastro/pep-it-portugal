---
import Layout from '../layouts/Layout.astro';
import { DataTable } from '../components/ui/DataTable';
import { GetFirstJob } from '../services/data';
import { LastUpdated } from '../components/ui/LastUpdated';
import { BarChartComponent } from '../components/charts/BarChartComponent';
import { ScatterChartComponent } from '../components/charts/ScatterChartComponent';

const data = await GetFirstJob();
const allData = data['Todos os dados'] || [];
const stats = data['Análise dos dados'] || [];

const statsData = stats.map((row: any) => {
    const newRow: Record<string, string | number> = {};
    Object.keys(row).forEach(key => {
        let val = row[key];
        const newKey = key === '' ? 'Tempo' : key;
        if (typeof val === 'string') {
            const num = Number(val.replace(/\s/g, '').replace(',', '.'));
            if (!isNaN(num) && val !== '') {
                newRow[newKey] = num;
            } else {
                newRow[newKey] = val;
            }
        } else {
            newRow[newKey] = val;
        }
    });
    return newRow;
});

const rawChartData = allData.map((row: any) => {
    const newRow: Record<string, string | number> = {};
    Object.keys(row).forEach(key => {
        let val = row[key];
        if (typeof val === 'string') {
            const num = Number(val.replace(/\s/g, '').replace(',', '.'));
            if (!isNaN(num) && val !== '') {
                newRow[key] = num;
            } else {
                newRow[key] = val;
            }
        } else {
            newRow[key] = val;
        }
    });
    return newRow;
});

const statBarKeys = ['Média Remuneração Recebida (BRUTO)', 'Média Remuneração Expectavel (BRUTO)'];
const xKey = 'Tempo';
---

<Layout title="Primeiro Emprego - PEP IT Portugal">
    <div class="mb-6">
        <h1 class="text-4xl font-bold text-slate-900 dark:text-white mb-2">Primeiro Emprego</h1>
        <p class="text-slate-600 dark:text-gray-400">Dados sobre estágios e posições de entrada.</p>
    </div>
    
    <div class="mb-12">
        <LastUpdated repository="pep-it-portugal-first-job" client:only="react" />
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
        {statsData.length > 0 && (
            <div class="lg:col-span-1">
                <BarChartComponent 
                    client:load 
                    title="Expectativa vs Realidade (Média)"
                    data={statsData} 
                    xKey={xKey} 
                    barKeys={statBarKeys} 
                />
            </div>
        )}

        {rawChartData.length > 0 && (
            <div class="lg:col-span-1">
                <ScatterChartComponent 
                    client:load
                    title="Expectativa vs Realidade (Raw)"
                    data={rawChartData}
                    xKey="Remuneração Mensal Expectável ?"
                    yKey="Remuneração Mensal Recebida ?"
                    xLabel="Remuneração Expectável"
                    yLabel="Remuneração Recebida"
                />
            </div>
        )}
    </div>

    <div style="display: flex; flex-direction: column; gap: 3rem;">
        {stats.length > 0 && <DataTable client:load data={stats} title="Estatísticas" />}
        {allData.length > 0 && <DataTable client:load data={allData} title="Todos os dados" />}
    </div>
</Layout>
