---
import Layout from '../layouts/Layout.astro';
import { DataTable } from '../components/ui/DataTable';
import { GetSalaries } from '../services/data';
import { BarChartComponent } from '../components/charts/BarChartComponent';
import { ScatterChartComponent } from '../components/charts/ScatterChartComponent';
import { LastUpdated } from '../components/ui/LastUpdated';

const data = await GetSalaries();
const allData = data['Todos os dados'] || [];
const statsPT = data['Análise dos dados Portugal'] || [];
const statsForeign = data['Análise dos dados Fora de Portugal'] || [];

const transformDataForChart = (tableData: any[]): Record<string, string | number>[] => {
    if (!tableData || tableData.length === 0) return [];
    
    return tableData.map((row: any) => {
        const newRow: Record<string, string | number> = {};
        Object.keys(row).forEach(key => {
             let val = row[key];
             const newKey = key === '' ? 'Categoria' : key;
             
             if(typeof val === 'string') {
                 // Clean value: remove € and replace european decimal format
                 const cleanVal = val.replace(/[€\s]/g, '').replace(/\./g, '').replace(',', '.');
                 const num = Number(cleanVal);
                 if(!isNaN(num) && cleanVal !== '') {
                     newRow[newKey] = num;
                 } else {
                     newRow[newKey] = val;
                 }
             } else {
                 newRow[newKey] = val;
             }
        });
        return newRow;
    });
}

const chartDataPT = transformDataForChart(statsPT);
const chartDataForeign = transformDataForChart(statsForeign);

const getNumericKeys = (data: any[]): string[] => {
    if (!data || data.length === 0) return [];
    return Object.keys(data[0]).filter(k => typeof data[0][k] === 'number' && k !== 'Nº Pessoas do Estudo');
}

const xKey = 'Categoria';
const ptBarKeys = getNumericKeys(chartDataPT);
const foreignBarKeys = getNumericKeys(chartDataForeign);
---

<Layout title="Salários - PEP IT Portugal">
    <div class="mb-6">
        <h1 class="text-4xl font-bold text-slate-900 dark:text-white mb-2">Salários</h1>
        <p class="text-slate-600 dark:text-gray-400">Análise detalhada dos salários em Portugal e no estrangeiro.</p>
    </div>
    
    <div class="mb-12">
        <LastUpdated repository="pep-it-portugal-salaries" client:only="react" />
    </div>

     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
        {chartDataPT.length > 0 && ptBarKeys.length > 0 && (
            <BarChartComponent 
                client:load 
                title="Distribuição Salarial Portugal"
                data={chartDataPT} 
                xKey={xKey} 
                barKeys={ptBarKeys} 
            />
        )}
         {chartDataForeign.length > 0 && foreignBarKeys.length > 0 && (
            <BarChartComponent 
                client:load 
                title="Distribuição Salarial Internacional"
                data={chartDataForeign} 
                xKey={xKey} 
                barKeys={foreignBarKeys} 
            />
        )}
     </div>

     {allData.length > 0 && (
         <div class="mb-16">
             <ScatterChartComponent 
                client:load
                title="Correlação: Anos de Experiência vs Salário"
                data={transformDataForChart(allData)}
                xKey="Anos de Experiência ?"
                yKey="Salário Bruto Anual (€)"
                xLabel="Anos de Experiência"
                yLabel="Salário Anual"
             />
         </div>
     )}

    <div style="display: flex; flex-direction: column; gap: 3rem;">
        {statsPT.length > 0 && <DataTable client:load data={statsPT} title="Tabela de Análise (Portugal)" />}
        {statsForeign.length > 0 && <DataTable client:load data={statsForeign} title="Tabela de Análise (Internacional)" />}
        {allData.length > 0 && <DataTable client:load data={allData} title="Todos os dados" />}
    </div>
</Layout>
