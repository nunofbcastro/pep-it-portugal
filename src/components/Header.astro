---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { ThemeToggle } from './ui/ThemeToggle';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const base = import.meta.env.BASE_URL === '/' ? '' : import.meta.env.BASE_URL;

const navItems = [
  { title: t('nav.companies'), href: `${base}/companies` },
  { title: t('nav.salaries'), href: `${base}/salaries` },
  {
    title: t('nav.more'),
    items: [
      { title: 'Cursos', href: `${base}/courses` },
      { title: 'Modo de trabalho', href: `${base}/workmode` },
      { title: 'Frameworks', href: `${base}/frameworks` },
      { title: 'ChatGPT', href: `${base}/chatgpt` },
      { title: 'Primeiro emprego', href: `${base}/firstjob` },
    ],
  },
];
---

<header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-800 sticky top-0 z-50 transition-colors">
  <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <div class="flex items-center">
        <a href={`${base}/`} class="flex items-center gap-2 flex-shrink-0" aria-label="Voltar para a pÃ¡gina inicial">
          <img src={`${base}/icon.png`} alt="Logo PorqueEUprogramo" class="w-8 h-8" width="32" height="32" loading="eager" />
          <span class="text-2xl font-bold text-pep-red">
            PorqueEUprogramo
          </span>
        </a>
      </div>
      <div class="hidden md:flex md:items-center md:gap-4">
        <div class="flex items-baseline space-x-4">
          {navItems.map((item) => (
            item.items ? (
              <div class="relative group">
                <button class="text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium inline-flex items-center transition-colors">
                  {item.title}
                  <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="absolute left-0 w-56 pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                  <div class="rounded-md shadow-lg bg-white dark:bg-slate-800 ring-1 ring-black ring-opacity-5 py-1 border border-slate-200 dark:border-slate-700">
                    {item.items.map((subItem) => (
                      <a href={subItem.href} class="block px-4 py-3 text-sm text-slate-600 dark:text-gray-300 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-white transition-colors">
                        {subItem.title}
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            ) : (
              <a
                href={item.href}
                class="text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors"
              >
                {item.title}
              </a>
            )
          ))}
        </div>
        <ThemeToggle client:only="react" />
      </div>
      <!-- Mobile menu button -->
      <div class="flex items-center gap-2 md:hidden">
        <ThemeToggle client:only="react" />
        <button type="button" class="bg-slate-100 dark:bg-slate-800 inline-flex items-center justify-center p-2 rounded-md text-slate-600 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-200 dark:hover:bg-slate-700 focus:outline-none transition-colors" aria-controls="mobile-menu" aria-expanded="false">
          <span class="sr-only">Abrir menu principal</span>
          <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- Mobile menu, show/hide based on menu state. -->
  <div class="md:hidden hidden" id="mobile-menu">
    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
       {navItems.map((item) => (
            item.items ? (
                <div class="space-y-1">
                    <div class="text-slate-600 dark:text-gray-300 px-3 py-2 rounded-md text-base font-medium">{item.title}</div>
                    {item.items.map(sub => (
                        <a href={sub.href} class="block pl-6 pr-3 py-2 rounded-md text-base font-medium text-slate-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">{sub.title}</a>
                    ))}
                </div>
            ) : (
             <a href={item.href} class="text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-700 block px-3 py-2 rounded-md text-base font-medium transition-colors">{item.title}</a>
            )
       ))}
    </div>
  </div>
</header>

<script>
  // Simple mobile menu toggle
  const btn = document.querySelector('button[aria-controls="mobile-menu"]');
  const menu = document.getElementById('mobile-menu');

  btn?.addEventListener('click', () => {
    const expanded = btn.getAttribute('aria-expanded') === 'true' || false;
    btn.setAttribute('aria-expanded', String(!expanded));
    menu?.classList.toggle('hidden');
  });
</script>
